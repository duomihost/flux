name: Build macOS White-Label App

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'åº”ç”¨åç§° (App Name)'
        required: true
        type: string
        default: 'Flux'
      bundle_id:
        description: 'Bundle Identifier (å¦‚: com.example.app)'
        required: true
        type: string
        default: 'com.example.yourapp'
      api_url:
        description: 'API åœ°å€ (å¦‚: https://api.example.com/api/v1)'
        required: true
        type: string
        default: 'https://api.example.com/api/v1'
      logo_url:
        description: 'Logo å›¾ç‰‡ URL (å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤)'
        required: false
        type: string
        default: ''
      build_number:
        description: 'æž„å»ºç¼–å· (Build Number)'
        required: false
        type: string
        default: '1'
      version_name:
        description: 'ç‰ˆæœ¬å· (Version Name, å¦‚: 1.0.0)'
        required: false
        type: string
        default: '1.0.0'
      upload_artifact:
        description: 'æ˜¯å¦ä¸Šä¼ æž„å»ºäº§ç‰©'
        required: false
        type: boolean
        default: true
      artifact_name:
        description: 'æž„å»ºäº§ç‰©åç§° (ä¸å«æ‰©å±•å)'
        required: false
        type: string
        default: ''

env:
  FLUTTER_VERSION: '3.35.4'

jobs:
  build:
    name: Build macOS App
    runs-on: macos-14

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ” Verify Flutter setup
        run: |
          flutter --version
          flutter doctor -v

      - name: ðŸ“¦ Install dependencies
        run: |
          flutter pub get

      - name: ðŸŽ¨ Download and prepare logo (if provided)
        if: ${{ inputs.logo_url != '' }}
        run: |
          mkdir -p assets/images
          curl -L -o assets/images/app_icon.png "${{ inputs.logo_url }}" || true

      - name: ðŸ”§ Configure app parameters
        run: |
          echo "ðŸ“ Configuring app parameters..."

          APP_NAME="${{ inputs.app_name }}"
          BUNDLE_ID="${{ inputs.bundle_id }}"
          VERSION_NAME="${{ inputs.version_name }}"
          BUILD_NUMBER="${{ inputs.build_number }}"

          echo "App Name: $APP_NAME"
          echo "Bundle ID: $BUNDLE_ID"
          echo "Version: $VERSION_NAME+$BUILD_NUMBER"

          # 1. AppInfo.xcconfig
          if [ -f "macos/Runner/Configs/AppInfo.xcconfig" ]; then
            sed -i '' "s|PRODUCT_NAME = .*|PRODUCT_NAME = $APP_NAME|" macos/Runner/Configs/AppInfo.xcconfig
            sed -i '' "s|PRODUCT_BUNDLE_IDENTIFIER = .*|PRODUCT_BUNDLE_IDENTIFIER = $BUNDLE_ID|" macos/Runner/Configs/AppInfo.xcconfig
          fi

          # 2. pubspec.yaml ä»…ä¿®æ”¹ version
          if [ -f "pubspec.yaml" ]; then
            sed -i '' "s|^version: .*|version: $VERSION_NAME+$BUILD_NUMBER|" pubspec.yaml
          fi

          # 3. ç¡®ä¿ macOS äºŒè¿›åˆ¶å¯æ‰§è¡Œ
          if [ -d "assets/bin/macos" ] && [ "$(ls -A assets/bin/macos 2>/dev/null)" ]; then
            chmod +x assets/bin/macos/* || true
          fi

      - name: ðŸ§¹ Clean previous builds
        run: |
          flutter clean
          rm -rf build/

      - name: ðŸ—ï¸ Build macOS app (Release)
        run: |
          flutter build macos --release --no-codesign

          APP_PATH="build/macos/Build/Products/Release/${{ inputs.app_name }}.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ App bundle not found"
            ls -la build/macos/Build/Products/Release/
            exit 1
          fi

      - name: ðŸ“¦ Create DMG package (native)
        id: create_dmg
        run: |
          APP_NAME="${{ inputs.app_name }}"
          VERSION="${{ inputs.version_name }}"
          BUILD="${{ inputs.build_number }}"
          APP_PATH="build/macos/Build/Products/Release/$APP_NAME.app"
          DMG_NAME="${APP_NAME}-macOS-${VERSION}-${BUILD}.dmg"

          mkdir -p dmg_root
          cp -R "$APP_PATH" dmg_root/

          hdiutil create \
            -volname "$APP_NAME" \
            -srcfolder dmg_root \
            -ov \
            -format UDZO \
            "$DMG_NAME"

          echo "dmg_path=$DMG_NAME" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Upload build artifacts
        if: ${{ inputs.upload_artifact == true }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name != '' && inputs.artifact_name || format('{0}-macOS-{1}-{2}', inputs.app_name, inputs.version_name, inputs.build_number) }}
          path: |
            build/macos/Build/Products/Release/*.app
            *.dmg
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ“Š Build summary
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| App | ${{ inputs.app_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ inputs.version_name }}+${{ inputs.build_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle ID | ${{ inputs.bundle_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æž„å»ºäº§ç‰©è¯·åœ¨ Actions â†’ Artifacts ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY
