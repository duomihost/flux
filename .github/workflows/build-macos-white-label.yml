name: Build macOS White-Label App

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'åº”ç”¨åç§° (App Name)'
        required: true
        type: string
        default: 'Flux'
      bundle_id:
        description: 'Bundle Identifier (å¦‚: com.example.app)'
        required: true
        type: string
        default: 'com.example.yourapp'
      api_url:
        description: 'API åœ°å€ (å¦‚: https://api.example.com/api/v1)'
        required: true
        type: string
        default: 'https://api.example.com/api/v1'
      logo_url:
        description: 'Logo å›¾ç‰‡ URL (å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤)'
        required: false
        type: string
        default: ''
      build_number:
        description: 'æž„å»ºç¼–å· (Build Number)'
        required: false
        type: string
        default: '1'
      version_name:
        description: 'ç‰ˆæœ¬å· (Version Name, å¦‚: 1.0.0)'
        required: false
        type: string
        default: '1.0.0'
      upload_artifact:
        description: 'æ˜¯å¦ä¸Šä¼ æž„å»ºäº§ç‰©'
        required: false
        type: boolean
        default: true
      artifact_name:
        description: 'æž„å»ºäº§ç‰©åç§° (ä¸å«æ‰©å±•å)'
        required: false
        type: string
        default: ''

env:
  FLUTTER_VERSION: '3.35.4'  # åŒ…å« Dart SDK 3.9.2ï¼Œæ»¡è¶³ä¾èµ–è¦æ±‚

jobs:
  build:
    name: Build macOS App
    runs-on: macos-14  # ä½¿ç”¨ macOS 14 (Sonoma) Runner
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ” Verify Flutter setup
        run: |
          flutter --version
          flutter doctor -v

      - name: ðŸ“¦ Install dependencies
        run: |
          flutter pub get
          # ä¸ä½¿ç”¨ flutter pub upgradeï¼Œé¿å…ä¾èµ–ç‰ˆæœ¬å†²çª

      - name: ðŸŽ¨ Download and prepare logo (if provided)
        id: prepare_logo
        if: ${{ inputs.logo_url != '' }}
        run: |
          echo "Downloading logo from ${{ inputs.logo_url }}"
          mkdir -p assets/images
          curl -L -o assets/images/app_icon.png "${{ inputs.logo_url }}" || echo "Logo download failed, using default"
          echo "logo_prepared=true" >> $GITHUB_OUTPUT

      - name: ðŸ”§ Configure app parameters
        run: |
          echo "ðŸ“ Configuring app parameters..."
          
          # è®¾ç½®å˜é‡
          APP_NAME="${{ inputs.app_name }}"
          BUNDLE_ID="${{ inputs.bundle_id }}"
          API_URL="${{ inputs.api_url }}"
          VERSION_NAME="${{ inputs.version_name }}"
          BUILD_NUMBER="${{ inputs.build_number }}"
          
          echo "App Name: $APP_NAME"
          echo "Bundle ID: $BUNDLE_ID"
          echo "API URL: $API_URL"
          echo "Version: $VERSION_NAME+$BUILD_NUMBER"
          
          # 1. ä¿®æ”¹ macOS AppInfo.xcconfig
          if [ -f "macos/Runner/Configs/AppInfo.xcconfig" ]; then
            sed -i '' "s/PRODUCT_NAME = .*/PRODUCT_NAME = $APP_NAME/" macos/Runner/Configs/AppInfo.xcconfig
            sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = .*/PRODUCT_BUNDLE_IDENTIFIER = $BUNDLE_ID/" macos/Runner/Configs/AppInfo.xcconfig
            echo "âœ… Updated AppInfo.xcconfig"
          fi
          
          # 2. ä¿®æ”¹ pubspec.yaml ç‰ˆæœ¬ä¿¡æ¯
          if [ -f "pubspec.yaml" ]; then
            sed -i '' "s/^version: .*/version: $VERSION_NAME+$BUILD_NUMBER/" pubspec.yaml
            sed -i '' "s/^name: .*/name: ${APP_NAME,,}/" pubspec.yaml || true
            echo "âœ… Updated pubspec.yaml"
          fi
          
          # 3. ä¿®æ”¹ API é…ç½®ï¼ˆé€šè¿‡çŽ¯å¢ƒå˜é‡æˆ–æž„å»ºæ—¶æ³¨å…¥ï¼‰
          # åˆ›å»ºä¸´æ—¶ API é…ç½®æ–‡ä»¶
          mkdir -p lib/services
          cat > lib/services/api_config_build.dart << EOF
          import 'package:shared_preferences/shared_preferences.dart';
          import 'remote_config_service.dart';

          class ApiConfig {
            static const _tokenKey = 'api_token';
            static const _authDataKey = 'api_auth_data';
            static const String _defaultApiUrl = '$API_URL';

            static String? _tokenCache;
            static String? _authDataCache;

            final RemoteConfigService _remoteConfig = RemoteConfigService();

            Future<String> getBaseUrl() async {
              try {
                return await _remoteConfig.getActiveDomain();
              } catch (e) {
                return _defaultApiUrl;
              }
            }

            Future<String?> getToken() async {
              final cached = _tokenCache;
              if (cached != null) return cached;
              final prefs = await SharedPreferences.getInstance();
              final value = prefs.getString(_tokenKey);
              _tokenCache = value;
              return value;
            }

            Future<void> setToken(String? token) async {
              _tokenCache = token;
              final prefs = await SharedPreferences.getInstance();
              if (token == null || token.isEmpty) {
                await prefs.remove(_tokenKey);
                return;
              }
              await prefs.setString(_tokenKey, token);
            }

            Future<String?> getAuthData() async {
              final cached = _authDataCache;
              if (cached != null) return cached;
              final prefs = await SharedPreferences.getInstance();
              final value = prefs.getString(_authDataKey);
              _authDataCache = value;
              return value;
            }

            Future<void> setAuthData(String? value) async {
              _authDataCache = value;
              final prefs = await SharedPreferences.getInstance();
              if (value == null || value.isEmpty) {
                await prefs.remove(_authDataKey);
                return;
              }
              await prefs.setString(_authDataKey, value);
            }

            Future<void> clearAuth() async {
              _tokenCache = null;
              _authDataCache = null;
              final prefs = await SharedPreferences.getInstance();
              await prefs.remove(_tokenKey);
              await prefs.remove(_authDataKey);
            }

            Future<void> refreshAuthCache() async {
              final prefs = await SharedPreferences.getInstance();
              _tokenCache = prefs.getString(_tokenKey);
              _authDataCache = prefs.getString(_authDataKey);
            }
          }
          EOF
          
          # å¤‡ä»½åŽŸæ–‡ä»¶å¹¶æ›¿æ¢
          if [ -f "lib/services/api_config.dart" ]; then
            cp lib/services/api_config.dart lib/services/api_config.dart.backup
          fi
          # æ— è®ºåŽŸæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œéƒ½æ›¿æ¢ä¸ºæ–°é…ç½®
          mv lib/services/api_config_build.dart lib/services/api_config.dart
          echo "âœ… Updated API config"
          
          # 4. ç¡®ä¿äºŒè¿›åˆ¶æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
          chmod +x assets/bin/macos/* || true
          
          echo "âœ… Configuration completed"

      - name: ðŸ§¹ Clean previous builds
        run: |
          flutter clean
          rm -rf build/

      - name: ðŸ—ï¸ Build macOS app (Release)
        run: |
          echo "ðŸš€ Building macOS app..."
          flutter build macos --release --no-codesign
          
          # éªŒè¯æž„å»ºäº§ç‰©
          if [ -d "build/macos/Build/Products/Release" ]; then
            APP_PATH="build/macos/Build/Products/Release/$APP_NAME.app"
            if [ -d "$APP_PATH" ]; then
              echo "âœ… Build successful: $APP_PATH"
              du -sh "$APP_PATH"
            else
              echo "âŒ App bundle not found at expected path"
              ls -la build/macos/Build/Products/Release/
              exit 1
            fi
          else
            echo "âŒ Build directory not found"
            exit 1
          fi

      - name: ðŸ“¦ Create DMG package (optional)
        id: create_dmg
        continue-on-error: true
        run: |
          APP_NAME="${{ inputs.app_name }}"
          APP_PATH="build/macos/Build/Products/Release/$APP_NAME.app"
          
          if [ -d "$APP_PATH" ]; then
            echo "ðŸ“¦ Creating DMG package..."
            
            # å®‰è£… create-dmg (å¦‚æžœå¯ç”¨)
            if ! command -v create-dmg &> /dev/null; then
              echo "âš ï¸ create-dmg not available, skipping DMG creation"
              echo "dmg_created=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            DMG_NAME="${APP_NAME// /_}-macOS-${{ inputs.version_name }}-${{ inputs.build_number }}.dmg"
            create-dmg \
              --volname "$APP_NAME" \
              --window-pos 200 120 \
              --window-size 800 400 \
              --icon-size 100 \
              --icon "$APP_NAME.app" 200 190 \
              --hide-extension "$APP_NAME.app" \
              --app-drop-link 600 185 \
              "$DMG_NAME" \
              "$APP_PATH" || true
            
            if [ -f "$DMG_NAME" ]; then
              echo "âœ… DMG created: $DMG_NAME"
              echo "dmg_path=$DMG_NAME" >> $GITHUB_OUTPUT
              echo "dmg_created=true" >> $GITHUB_OUTPUT
            else
              echo "dmg_created=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "dmg_created=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Upload build artifacts
        if: ${{ inputs.upload_artifact == true }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name != '' && inputs.artifact_name || format('{0}-macOS-{1}-{2}', inputs.app_name, inputs.version_name, inputs.build_number) }}
          path: |
            build/macos/Build/Products/Release/${{ inputs.app_name }}.app
            ${{ steps.create_dmg.outputs.dmg_path }}
          retention-days: 30
          if-no-files-found: error

      - name: ðŸ“Š Build summary
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| åº”ç”¨åç§° | ${{ inputs.app_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle ID | ${{ inputs.bundle_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API åœ°å€ | ${{ inputs.api_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬å· | ${{ inputs.version_name }}+${{ inputs.build_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºäº§ç‰© | âœ… å·²ä¸Šä¼  |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æž„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° GitHub Actions Artifactsï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY
